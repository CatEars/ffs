<!-- layout /templates/base.html -->
<app-main>
    <script type="module">
        let usernameInput = null;
        let passwordInput = null;

        async function handleAction(endpoint, actionName) {
            state.isLoading = true;
            state.message = null;

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                if (response.ok) {
                    state.messageType = 'success';
                    state.message = `${actionName} completed successfully`;
                } else {
                    const result = await response.json();
                    state.messageType = 'error';
                    state.message = result.error || result.message || `${actionName} failed`;
                }
            } catch (error) {
                state.messageType = 'error';
                state.message = `Error: ${error.message}`;
            } finally {
                state.isLoading = false;
            }
        }

        async function clearManifests() {
            await handleAction('/api/admin/clear-manifests', 'Clear Share Link Manifests');
        }

        async function clearThumbnails() {
            await handleAction('/api/admin/clear-thumbnails', 'Clear Thumbnails');
        }

        async function createUser() {
            if (state.isLoading.value) return;
            const username = usernameInput?.value ?? '';
            const password = passwordInput?.value ?? '';

            state.isLoading = true;
            state.message = null;

            try {
                const response = await fetch('/api/admin/create-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password }),
                });

                if (response.ok) {
                    state.messageType = 'success';
                    state.message = `User '${username}' created successfully`;
                    state.createUserFormVersion = state.createUserFormVersion.value + 1;
                } else {
                    const result = await response.json();
                    state.messageType = 'error';
                    state.message = result.error || result.message || 'Create User failed';
                }
            } catch (error) {
                state.messageType = 'error';
                state.message = `Error: ${error.message}`;
            } finally {
                state.isLoading = false;
            }
        }

        const megaphone = new Megaphone();
        const state = megaphone.declareState({
            message: null,
            messageType: null,
            isLoading: false,
            canCreateUsers: false,
            createUserFormVersion: 1,
            hasMessage: megaphone.view((state) => state.message !== null),
            showCreateUserForm: megaphone.view((state) =>
                state.canCreateUsers && state.createUserFormVersion
            ),
            buttonsDisabled: megaphone.view((state) => state.isLoading || undefined),
            clearManifests,
            clearThumbnails,
        });

        megaphone.renderIf(
            state.hasMessage,
            '#message-display',
            megaphone.template('#message-template', (clone) => {
                const messageEl = clone.querySelector('.message');
                messageEl.textContent = state.message.value;
                messageEl.className = `message ${state.messageType.value}`;
                return clone;
            })
        );

        megaphone.renderIf(
            state.showCreateUserForm,
            '#create-user-section',
            megaphone.template('#create-user-template', (clone) => {
                usernameInput = clone.querySelector('[name=username]');
                passwordInput = clone.querySelector('[name=password]');
                clone.querySelector('[data-action=create-user]').addEventListener('click', createUser);
                return clone;
            })
        );

        megaphone.init();

        fetch('/api/user/capabilities').then(async (res) => {
            if (res.ok) {
                const caps = await res.json();
                state.canCreateUsers = caps.canCreateUsers;
            }
        });
    </script>

    <app-header>Admin</app-header>

    <section>
        <p>Administrative actions for managing the FFS file server.</p>
    </section>

    <horizontal-ruler></horizontal-ruler>

    <section>
        <h2>Thumbnails</h2>
        <p>Remove all cached thumbnail images. These will be regenerated when files are viewed.</p>
        <button $disabled="buttonsDisabled" @click="clearThumbnails" type="button">Clear Thumbnails</button>
    </section>

    <horizontal-ruler></horizontal-ruler>

    <section>
        <h2>Share Link Manifests</h2>
        <p>Remove all cached share link manifest files. <strong>Warning: existing share links will no longer be accessible after clearing.</strong></p>
        <button $disabled="buttonsDisabled" @click="clearManifests" type="button">Clear Share Link Manifests</button>
    </section>

    <div id="create-user-section">
        <template id="create-user-template">
            <horizontal-ruler></horizontal-ruler>
            <section>
                <h2>Create Ephemeral User</h2>
                <p>Create a new ephemeral user account with a password.</p>
                <div>
                    <label for="new-username">Username</label>
                    <input type="text" id="new-username" name="username" placeholder="Username" autocomplete="off" />
                </div>
                <div>
                    <label for="new-password">Password</label>
                    <input type="password" id="new-password" name="password" placeholder="Password" autocomplete="new-password" />
                </div>
                <button data-action="create-user" type="button">Create User</button>
            </section>
        </template>
    </div>

    <horizontal-ruler></horizontal-ruler>

    <section id="message-display">
        <template id="message-template">
            <div class="message"></div>
            <style>
                .message {
                    padding: 1rem;
                    margin: 1rem 0;
                    border-radius: 4px;
                    border: 1px solid;
                }
                .message.success {
                    background-color: #d4edda;
                    border-color: #c3e6cb;
                    color: #155724;
                }
                .message.error {
                    background-color: #f8d7da;
                    border-color: #f5c6cb;
                    color: #721c24;
                }
            </style>
        </template>
    </section>
</app-main>
