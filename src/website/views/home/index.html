<!-- layout /templates/base.html -->
<app-main>
    <script>
        function filesWithUnstringifiedDate(files) {
            return files.map((file) => ({ ...file, date: new Date(file.date) }));
        }

        function includeParentUnlessRoot(files, currentPath) {
            if (currentPath === '.') {
                return files;
            }

            return [
                {
                    name: '..',
                    isDirectory: true,
                    fileType: 'directory',
                    imageSrc: 'folder',
                },
            ].concat(files);
        }

        function paginate(array, page, pageSize) {
            const startIndex = (page - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            return array.slice(startIndex, endIndex);
        }

        function getNumPages(array, pageSize) {
            return Math.ceil(array.length / pageSize);
        }

        function sortedBy(files, sorting, directoriesFirst, page, pageSize) {
            const sortingFunction =
                sorting === 'oldest'
                    ? (a, b) => a.date - b.date
                    : sorting === 'newest'
                    ? (a, b) => b.date - a.date
                    : sorting === 'a-z'
                    ? (a, b) => a.name.localeCompare(b.name, 'en', { sensitivity: 'accent' })
                    : sorting === 'z-a'
                    ? (a, b) => -a.name.localeCompare(b.name, 'en', { sensitivity: 'accent' })
                    : () => {};

            let copy = files.toSorted(sortingFunction);
            if (directoriesFirst) {
                const directoryFirstSorter = (a, b) =>
                    a.isDirectory && !b.isDirectory ? -1 : !a.isDirectory && b.isDirectory ? 1 : 0;
                copy = copy.toSorted(directoryFirstSorter);
            }

            return paginate(copy, page, pageSize);
        }

        function getCurrentPath() {
            return getUrlParam('path', '.');
        }

        function calculatePath(root, fileName) {
            if (fileName === '..') {
                const lastIndex = root.lastIndexOf('/');
                if (lastIndex === -1) {
                    return root;
                }
                return root.substring(0, lastIndex);
            } else {
                return encodeURIComponent(`${root}/${fileName}`);
            }
        }

        function getCurrentPage() {
            return Number.parseInt(getUrlParam('page', '1'));
        }

        function setCurrentPage(pageNum) {
            setUrlParam('page', `${pageNum}`);
            return pageNum;
        }

        function isSoundFile(file) {
            return file.endsWith('.mp3');
        }

        function isImageFile(file) {
            // LINK-FILE-EXTENSIONS
            return [
                '.png',
                '.jpg',
                '.jpeg',
                '.tiff',
                '.webp',
                '.gif',
                '.avif',
                '.bmp',
                '.ico',
                '.psd',
            ].some((x) => file.endsWith(x));
        }

        function isMovieFile(file) {
            return ['.mp4', '.m4v', '.mov', '.avi', '.webm', '.mkv', '.mpg'].some((x) =>
                file.endsWith(x)
            );
        }

        function isMediaFile(file) {
            return isSoundFile(file) || isImageFile(file) || isMovieFile(file);
        }

        function resolveSvgLocationForFile(file) {
            if (isSoundFile(file.name)) {
                return 'music_note';
            } else if (isImageFile(file.name)) {
                return 'photo_camera';
            } else if (isMovieFile(file.name)) {
                return 'videocam';
            } else if (file.isDirectory) {
                return 'folder';
            } else {
                return 'description';
            }
        }

        function getFileImageSource(root, file) {
            if (isMovieFile(file.name) || (isImageFile(file.name) && !file.name.endsWith('.gif'))) {
                return `/api/thumbnail?path=${encodeURIComponent(root + '/' + file.name)}`;
            }
            return '';
        }

        function storeToCuttingBoard(files) {
            return setSessionStorage('cutting-board', files);
        }

        function getCuttingBoard() {
            return getSessionStorage('cutting-board', []);
        }

        function resetCuttingBoard() {
            storeToCuttingBoard([]);
        }

        function navigateToHomePath(path, index) {
            const elements = path.split('/');
            const selectedLocation = elements.slice(0, index + 1).join('/');
            const webPath = `/home/?path=${selectedLocation}`;
            window.location.href = webPath;
        }

        function getBaseLinkTo(file) {
            const currentPath = decodeURIComponent(getCurrentPath());
            return calculatePath(currentPath, file.name);
        }

        function getMediaLinkTo(file) {
            return `/home/media/view?path=${getBaseLinkTo(file)}`;
        }

        function getHomeLinkTo(file) {
            return `/home/?path=${getBaseLinkTo(file)}`;
        }

        function getCheckedFiles() {
            const clickedFiles = [];
            for (const element of document.querySelectorAll('.file-to-cut')) {
                if (element.checked) {
                    clickedFiles.push(element.value);
                }
                element.checked = false;
            }
            return clickedFiles;
        }

        function cutFiles() {
            const myPath = getCurrentPath();
            const clickedFiles = getCheckedFiles();
            const filesToStore = clickedFiles.map((elem) => ({
                path: myPath,
                fileName: elem,
            }));
            if (filesToStore.length > 0) {
                storeToCuttingBoard(filesToStore);
            }
        }

        function pasteFiles() {
            const path = decodeURIComponent(getCurrentPath());
            const board = getCuttingBoard();
            resetCuttingBoard();
            document.getElementById('files-to-move').value = JSON.stringify(board);
            document.getElementById('destination').value = path;
            document.getElementById('paste-form').submit();
        }

        function deleteFiles() {
            const myPath = getCurrentPath();
            const clickedFiles = getCheckedFiles();
            const filesToRemove = clickedFiles.map((elem) => ({
                path: myPath,
                fileName: elem,
            }));
            document.getElementById('files-to-remove').value = JSON.stringify(filesToRemove);
            document.getElementById('delete-form').submit();
        }

        function createFileShare() {
            const myPath = getCurrentPath();
            const paths = getCheckedFiles().map((x) => `${myPath}/${x}`);
            document.getElementById('link-paths').value = JSON.stringify(paths);
            document.getElementById('link-form').submit();
        }

        function renameFile() {
            const myPath = getCurrentPath();
            const checkedFiles = getCheckedFiles();
            if (checkedFiles.length === 0) {
                return;
            }
            const elementToRename = checkedFiles[0];
            const renameForm = document.getElementById('rename-form');
            document.getElementById('source').value = `${myPath}/${elementToRename}`;
            renameForm.submit();
        }

        function makeDirectory() {
            const myPath = getCurrentPath();
            document.getElementById('make-directory-path').value = myPath;
            document.getElementById('make-directory-form').submit();
        }
    </script>
    <script type="module">
        function onCrumbClick(evt) {
            navigateToHomePath(evt.detail.trail, evt.detail.index);
        }

        function onSortDirectoriesFirstChange(evt) {
            state.directoriesFirst = evt.detail.checked;
        }

        function createSortingSetter(value) {
            return () => {
                state.sorting = value;
            };
        }

        function onPageShift(evt) {
            state.currentPage = evt.detail.page;
        }

        function generatePageSizeUpdater(value) {
            return () => {
                state.pageSize = value;
            };
        }

        function onGalleryModeSelected() {
            state.viewMode = 'gallery';
        }

        function onFileManagerModeSelected() {
            state.viewMode = 'files';
        }

        const megaphone = new Megaphone();
        const currentPath = getCurrentPath();
        const state = megaphone.declareState({
            pageSize: megaphone.localStorage('default-page-size', 100),
            currentPath,

            viewMode: megaphone.sessionStorage('view-mode', 'gallery'),
            galleryModeEnabled: megaphone.view((state) => state.viewMode === 'gallery'),
            galleryVisibility: megaphone.view((state) =>
                state.galleryModeEnabled ? 'show' : 'hidden'
            ),
            fileManagerModeEnabled: megaphone.view((state) => state.viewMode === 'files'),
            fileManagerVisibility: megaphone.view((state) =>
                state.fileManagerModeEnabled ? 'show' : 'hidden'
            ),

            files: megaphone.jsonApi(`/api/directory?path=${currentPath}`, [], {
                view: (files) =>
                    includeParentUnlessRoot(filesWithUnstringifiedDate(files), currentPath),
            }),
            maxPages: megaphone.view((state) => getNumPages(state.files, state.pageSize)),
            sorting: megaphone.localStorage('file-sort-order', 'newest'),
            directoriesFirst: megaphone.localStorage('show-directories-first', true),
            currentPage: getCurrentPage(),
            sortedFiles: megaphone.view((state) =>
                sortedBy(
                    state.files,
                    state.sorting,
                    state.directoriesFirst,
                    state.currentPage,
                    state.pageSize
                )
            ),

            sortingByNewest: megaphone.view((state) => state.sorting === 'newest'),
            sortingByOldest: megaphone.view((state) => state.sorting === 'oldest'),
            sortingByAtoZ: megaphone.view((state) => state.sorting === 'a-z'),
            sortingByZtoA: megaphone.view((state) => state.sorting === 'z-a'),
            sortByNewest: createSortingSetter('newest'),
            sortByOldest: createSortingSetter('oldest'),
            sortByAtoZ: createSortingSetter('a-z'),
            sortByZtoA: createSortingSetter('z-a'),

            setPageSizeTo20: generatePageSizeUpdater(20),
            setPageSizeTo50: generatePageSizeUpdater(50),
            setPageSizeTo100: generatePageSizeUpdater(100),
            setPageSizeTo250: generatePageSizeUpdater(250),
            setPageSizeTo1000: generatePageSizeUpdater(1000),

            pageSizeIs20: megaphone.view((state) => state.pageSize === 20),
            pageSizeIs50: megaphone.view((state) => state.pageSize === 50),
            pageSizeIs100: megaphone.view((state) => state.pageSize === 100),
            pageSizeIs250: megaphone.view((state) => state.pageSize === 250),
            pageSizeIs1000: megaphone.view((state) => state.pageSize === 1000),

            onGalleryModeSelected,
            onFileManagerModeSelected,
            onSortDirectoriesFirstChange,
            onCrumbClick,
            onPageShift,
            pasteFiles,
            cutFiles,
            resetCuttingBoard,
            createFileShare,
            renameFile,
            makeDirectory,
            deleteFiles,
        });

        megaphone.renderEach(
            state.sortedFiles,
            '#gallery',
            megaphone.webComponent('file-card', (file) => ({
                filename: file.name,
                'file-type': file.fileType,
                'image-src': file.imageSrc,
                root: currentPath,
            }))
        );

        megaphone.renderEach(
            state.sortedFiles,
            '#file-list',
            megaphone.template('#file-row-entry', (clone, file) => {
                clone.querySelector('input').value = file.name;
                clone
                    .querySelector('use')
                    .setAttribute(
                        'href',
                        `/static/svg/sprite_sheet.svg#${resolveSvgLocationForFile(file)}`
                    );
                const imageSource = getFileImageSource(currentPath, file);
                const iconHover = clone.querySelector('icon-hover');
                if (file.isFile) {
                    iconHover.setAttribute('url', imageSource);
                } else if (file.isDirectory) {
                    iconHover.setAttribute('disabled', 'true');
                }

                const fileLink = clone.querySelector('#file-link-row').content.cloneNode(true);
                const fl = fileLink.querySelector('file-link');
                fl.setAttribute('filename', file.name);
                fl.setAttribute('file-type', file.fileType);
                fl.setAttribute('root', decodeURIComponent(getCurrentPath()));
                clone.querySelector('div.file-row-text').appendChild(fl);

                return clone;
            })
        );

        megaphone.init();
    </script>
    <app-header>
        <breadcrumb-nav
            slot="ender"
            $trail="currentPath"
            @crumb-click="onCrumbClick"
        ></breadcrumb-nav>
    </app-header>
    <horizontal-ruler></horizontal-ruler>
    <paginate-control
        $page="currentPage"
        $max-pages="maxPages"
        @page-shift="onPageShift"
    ></paginate-control>

    <div $data-visibility="galleryVisibility">
        <section id="gallery" class="gallery"></section>
    </div>
    <div $data-visibility="fileManagerVisibility">
        <!-- include ./file-manager.partial.html -->
    </div>
    <paginate-control
        $page="currentPage"
        $max-pages="maxPages"
        @page-shift="onPageShift"
    ></paginate-control>
    <horizontal-ruler></horizontal-ruler>
    <drop-down>
        <p slot="header">Options</p>
        <!-- include ./control-panel.partial.html -->
    </drop-down>

    <div $data-visibility="fileManagerVisibility">
        <!-- include ./file-manager-footer.partial.html -->
    </div>
</app-main>
