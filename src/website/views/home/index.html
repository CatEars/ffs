<% layout('/templates/base.html') %>
<section>
  <script>
    async function getFiles(rootPath) {
      const response = await fetch(`/api/directory?path=${rootPath}`);
      if (response.status === 200) {
        const result = await response.json();
        result.sort((a, b) => a.isDirectory < b.isDirectory);
        if (rootPath === ".") {
          return result;
        }
        const resultWithParent = [
          {
            name: "..",
            isDirectory: true,
          },
        ].concat(result);
        return resultWithParent;
      }
      return [];
    }

    function updatePath(root, folder) {
      if (folder === "..") {
        return popFolder(root);
      }
      return `${root}/${folder}`;
    }

    function popFolder(root) {
      const lastSlashIndex = root.lastIndexOf("/");
      if (lastSlashIndex === -1) {
        return root;
      } else {
        return root.substring(0, lastSlashIndex);
      }
    }
  </script>
  <h2>Files</h2>
  <div x-data="{ root: '.', files: [] }">
    <ul x-effect="files = await getFiles(root);">
      <template x-for="(file) in files" :key="file.name">
        <li>
          <template x-if="file.isDirectory">
            <button @click="root = updatePath(root, file.name)">
              <span x-text="file.name"></span>
            </button>
          </template>
          <template x-if="file.isFile">
            <div>
              <span x-text="file.name"></span>
              <a
                x-bind:href="`/api/file?path=${root}/${file.name}`"
                x-bind:download="file.name"
                >Download</a
              >
            </div>
          </template>
        </li>
      </template>
    </ul>
  </div>
</section>
