<!-- layout /templates/base.html -->
<app-main
    x-data="{
        sorting: getLocalStorage('file-sort-order', 'newest'), 
        directoriesFirst: getLocalStorage('show-directories-first', true),
        files: [], 
        filesDisplay: getCuttingBoardDisplay(), 
        filesToGrey: [],
        root: getCurrentPath(), 
        currentPage: getCurrentPage()
     }"
>
    <script>
        const defaultPageSize = 120;

        function mapDateStrToDate(entries) {
            for (const entry of entries) {
                entry.date = new Date(entry.date);
            }
        }

        async function getFiles(rootPath) {
            const response = await fetch(`/api/directory?path=${rootPath}`);
            if (response.status === 200) {
                const result = await response.json();
                mapDateStrToDate(result);
                if (rootPath === '.') {
                    return result;
                }
                const resultWithParent = [
                    {
                        name: '..',
                        isDirectory: true,
                        fileType: 'directory',
                        imageSrc: 'folder',
                    },
                ].concat(result);
                return resultWithParent;
            }
            return [];
        }

        function paginate(array, page, pageSize = defaultPageSize) {
            const startIndex = (page - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            return array.slice(startIndex, endIndex);
        }

        function getNumPages(array, pageSize = defaultPageSize) {
            return Math.ceil(array.length / pageSize);
        }

        function sortedBy(files, sorting, directoriesFirst, page, pageSize = defaultPageSize) {
            const copy = JSON.parse(JSON.stringify(files));
            mapDateStrToDate(copy);

            const sortingFunction =
                sorting === 'oldest'
                    ? (a, b) => a.date - b.date
                    : sorting === 'newest'
                    ? (a, b) => b.date - a.date
                    : sorting === 'a-z'
                    ? (a, b) => a.name.localeCompare(b.name, 'en', { sensitivity: 'accent' })
                    : sorting === 'z-a'
                    ? (a, b) => -a.name.localeCompare(b.name, 'en', { sensitivity: 'accent' })
                    : () => {};

            copy.sort(sortingFunction);
            if (directoriesFirst) {
                const directoryFirstSorter = (a, b) =>
                    a.isDirectory && !b.isDirectory ? -1 : !a.isDirectory && b.isDirectory ? 1 : 0;
                copy.sort(directoryFirstSorter);
            }

            return paginate(copy, page, pageSize);
        }

        function getCurrentPath() {
            return getUrlParam('path', '.');
        }

        function calculatePath(root, fileName) {
            if (fileName === '..') {
                const l = ''.lastI;
                const lastIndex = root.lastIndexOf('/');
                if (lastIndex === -1) {
                    return root;
                }
                return root.substring(0, lastIndex);
            } else {
                return encodeURIComponent(`${root}/${fileName}`);
            }
        }

        function getCurrentPage() {
            return Number.parseInt(getUrlParam('page', '1'));
        }

        function setCurrentPage(pageNum) {
            setUrlParam('page', `${pageNum}`);
            return pageNum;
        }

        function isSoundFile(file) {
            return file.endsWith('.mp3');
        }

        function isImageFile(file) {
            return ['.png', '.jpg', '.jpeg', '.gif'].some((x) => file.endsWith(x));
        }

        function isMovieFile(file) {
            return ['.mp4', '.m4v'].some((x) => file.endsWith(x));
        }

        function isMediaFile(file) {
            return isSoundFile(file) || isImageFile(file) || isMovieFile(file);
        }

        function resolveSvgLocationForFile(file) {
            if (isSoundFile(file.name)) {
                return 'music_note';
            } else if (isImageFile(file.name)) {
                return 'photo_camera';
            } else if (isMovieFile(file.name)) {
                return 'videocam';
            } else if (file.isDirectory) {
                return 'folder';
            } else {
                return 'description';
            }
        }

        function getFileImageSource(root, file) {
            if (isMovieFile(file.name) || (isImageFile(file.name) && !file.name.endsWith('.gif'))) {
                return `/api/thumbnail?path=${encodeURIComponent(root + '/' + file.name)}`;
            }
            return '';
        }

        function storeToCuttingBoard(files) {
            return setSessionStorage('cutting-board', files);
        }

        function getCuttingBoard() {
            return getSessionStorage('cutting-board', []);
        }

        function getCuttingBoardDisplay() {
            return `${getCuttingBoard().length} files in cutting board`;
        }

        function resetCuttingBoard() {
            storeToCuttingBoard([]);
        }

        function fileInCuttingBoard(file) {
            const myPath = decodeURIComponent(getCurrentPath());
            return getCuttingBoard().some((x) => x.path === myPath && x.fileName === file.name);
        }

        function findFilesToGrey() {
            const myPath = decodeURIComponent(getCurrentPath());
            return getCuttingBoard()
                .filter((x) => x.path === myPath)
                .map((x) => x.fileName);
        }
    </script>
    <div
        style="display: none"
        x-effect="files = await getFiles(getCurrentPath()); filesToGrey = findFilesToGrey()"
    ></div>
    <app-header>
        <breadcrumb-nav
            slot="ender"
            x-bind:trail="root"
            @crumb-click="evt => navigateToHomePath(evt.detail.trail, evt.detail.index)"
        ></breadcrumb-nav>
    </app-header>
    <!-- include ./control-panel.partial.html -->
    <paginate-control
        x-bind:page="currentPage"
        x-bind:max-pages="getNumPages(files)"
        @page-shift="evt => currentPage = setCurrentPage(evt.detail.page)"
    ></paginate-control>

    <div id="gallery-holder" data-visibility="show">
        <!-- include ./gallery.partial.html -->
    </div>
    <div id="file-manager-holder" $data-visibility="galleryMode" data-visibility="hidden">
        <!-- include ./file-manager.partial.html -->
    </div>
    <paginate-control
        x-bind:page="currentPage"
        x-bind:max-pages="getNumPages(files)"
        @page-shift="evt => currentPage = setCurrentPage(evt.detail.page)"
    ></paginate-control>
    <script type="module">
        class ReactivityMegaphone {
            constructor() {
                this.pairs = [];
                this.dollars = [];
                this.state = null;
            }

            pair(stateProxy, callable) {
                this.pairs.push([stateProxy.property, callable]);
            }

            onUpdate(target, property, value) {
                console.log('updating', this.dollars, property, value);
                for (const dollar of this.dollars) {
                    if (dollar.value === property) {
                        const attributeName = dollar.name.substring(1);
                        dollar.element.setAttribute(attributeName, `${value}`);
                    }
                }
                for (const [propertyName, callable] of this.pairs) {
                    if (property === propertyName) {
                        callable(value);
                    }
                }
            }

            declareState(state) {
                if (this.state !== null) {
                    throw new Error('You may only declare state once!');
                }
                this.state = state;
                const me = this;
                return new Proxy(state, {
                    set(target, property, value) {
                        me.onUpdate(target, property, value);
                        return Reflect.set(target, property, value);
                    },
                    get(target, property, receiver) {
                        return {
                            value: target[property],
                            property,
                        };
                    },
                });
            }

            init() {
                const dollars = [];
                for (const element of document.querySelectorAll('*')) {
                    for (const attribute of element.attributes) {
                        if (attribute.name.startsWith('$')) {
                            attribute.value;
                            dollars.push({
                                element,
                                name: attribute.name,
                                value: attribute.value,
                            });
                        }
                    }
                }
                this.dollars = dollars;

                for (const key of Object.keys(this.state)) {
                    this.onUpdate(this.state, key, this.state[key]);
                }
            }
        }

        const megaphone = new ReactivityMegaphone();
        const state = megaphone.declareState({
            galleryMode: getSessionStorage('gallery-mode', true),
            fileManagerMode: false,
        });

        function renderGalleryOrFileManager(galleryMode) {
            document
                .querySelector('#gallery-holder')
                .setAttribute('data-visibility', galleryMode ? 'show' : 'hidden');
            document
                .querySelector('#file-manager-holder')
                .setAttribute('data-visibility', galleryMode ? 'hidden' : 'show');
        }

        function onGalleryModeChange(evt) {
            state.galleryMode = evt.detail.checked;
        }
        document.querySelector('#view-mode-switch').addEventListener('change', onGalleryModeChange);

        megaphone.pair(state.galleryMode, renderGalleryOrFileManager);
        megaphone.pair(state.galleryMode, (galleryMode) => (state.fileManagerMode = !galleryMode));
        megaphone.init();
    </script>
</app-main>
