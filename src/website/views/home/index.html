<!-- layout /templates/base.html -->
<app-main
    x-data="{
        sorting: getLocalStorage('file-sort-order', 'newest'), 
        directoriesFirst: getLocalStorage('show-directories-first', true),
        files: [], 
        filesDisplay: getCuttingBoardDisplay(), 
        filesToGrey: [],
        root: getCurrentPath(), 
        currentPage: getCurrentPage()
     }"
>
    <script>
        const defaultPageSize = 120;

        function mapDateStrToDate(entries) {
            for (const entry of entries) {
                entry.date = new Date(entry.date);
            }
        }

        async function getFiles(rootPath) {
            const response = await fetch(`/api/directory?path=${rootPath}`);
            if (response.status === 200) {
                const result = await response.json();
                mapDateStrToDate(result);
                if (rootPath === '.') {
                    return result;
                }
                const resultWithParent = [
                    {
                        name: '..',
                        isDirectory: true,
                        fileType: 'directory',
                        imageSrc: 'folder',
                    },
                ].concat(result);
                return resultWithParent;
            }
            return [];
        }

        function paginate(array, page, pageSize = defaultPageSize) {
            const startIndex = (page - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            return array.slice(startIndex, endIndex);
        }

        function getNumPages(array, pageSize = defaultPageSize) {
            return Math.ceil(array.length / pageSize);
        }

        function sortedBy(files, sorting, directoriesFirst, page, pageSize = defaultPageSize) {
            const copy = JSON.parse(JSON.stringify(files));
            mapDateStrToDate(copy);

            const sortingFunction =
                sorting === 'oldest'
                    ? (a, b) => a.date - b.date
                    : sorting === 'newest'
                    ? (a, b) => b.date - a.date
                    : sorting === 'a-z'
                    ? (a, b) => a.name.localeCompare(b.name, 'en', { sensitivity: 'accent' })
                    : sorting === 'z-a'
                    ? (a, b) => -a.name.localeCompare(b.name, 'en', { sensitivity: 'accent' })
                    : () => {};

            copy.sort(sortingFunction);
            if (directoriesFirst) {
                const directoryFirstSorter = (a, b) =>
                    a.isDirectory && !b.isDirectory ? -1 : !a.isDirectory && b.isDirectory ? 1 : 0;
                copy.sort(directoryFirstSorter);
            }

            return paginate(copy, page, pageSize);
        }

        function getCurrentPath() {
            return getUrlParam('path', '.');
        }

        function calculatePath(root, fileName) {
            if (fileName === '..') {
                const l = ''.lastI;
                const lastIndex = root.lastIndexOf('/');
                if (lastIndex === -1) {
                    return root;
                }
                return root.substring(0, lastIndex);
            } else {
                return encodeURIComponent(`${root}/${fileName}`);
            }
        }

        function getCurrentPage() {
            return Number.parseInt(getUrlParam('page', '1'));
        }

        function setCurrentPage(pageNum) {
            setUrlParam('page', `${pageNum}`);
            return pageNum;
        }

        function isSoundFile(file) {
            return file.endsWith('.mp3');
        }

        function isImageFile(file) {
            return ['.png', '.jpg', '.jpeg', '.gif'].some((x) => file.endsWith(x));
        }

        function isMovieFile(file) {
            return ['.mp4', '.m4v'].some((x) => file.endsWith(x));
        }

        function isMediaFile(file) {
            return isSoundFile(file) || isImageFile(file) || isMovieFile(file);
        }

        function resolveSvgLocationForFile(file) {
            if (isSoundFile(file.name)) {
                return 'music_note';
            } else if (isImageFile(file.name)) {
                return 'photo_camera';
            } else if (isMovieFile(file.name)) {
                return 'videocam';
            } else if (file.isDirectory) {
                return 'folder';
            } else {
                return 'description';
            }
        }

        function getFileImageSource(root, file) {
            if (isMovieFile(file.name) || (isImageFile(file.name) && !file.name.endsWith('.gif'))) {
                return `/api/thumbnail?path=${encodeURIComponent(root + '/' + file.name)}`;
            }
            return '';
        }

        function storeToCuttingBoard(files) {
            return setSessionStorage('cutting-board', files);
        }

        function getCuttingBoard() {
            return getSessionStorage('cutting-board', []);
        }

        function getCuttingBoardDisplay() {
            return `${getCuttingBoard().length} files in cutting board`;
        }

        function resetCuttingBoard() {
            storeToCuttingBoard([]);
        }

        function fileInCuttingBoard(file) {
            const myPath = decodeURIComponent(getCurrentPath());
            return getCuttingBoard().some((x) => x.path === myPath && x.fileName === file.name);
        }

        function findFilesToGrey() {
            const myPath = decodeURIComponent(getCurrentPath());
            return getCuttingBoard()
                .filter((x) => x.path === myPath)
                .map((x) => x.fileName);
        }

        function navigateToHomePath(path, index) {
            const elements = path.split('/');
            const selectedLocation = elements.slice(0, index + 1).join('/');
            const webPath = `/home/?path=${selectedLocation}`;
            window.location.href = webPath;
        }

        const megaphone = new Megaphone();
        const state = megaphone.declareState({
            currentPath: getCurrentPath(),
            galleryMode: getSessionStorage('gallery-mode', true),
            galleryVisibility: megaphone.view((state) => (state.galleryMode ? 'show' : 'hidden')),
            fileManagerVisibility: megaphone.view((state) =>
                state.galleryMode ? 'hidden' : 'show'
            ),
        });

        function onGalleryModeChange(evt) {
            state.galleryMode = evt.detail.checked;
        }

        function onCrumbClick(evt) {
            navigateToHomePath(evt.detail.trail, evt.detail.index);
        }
    </script>
    <div
        style="display: none"
        x-effect="files = await getFiles(getCurrentPath()); filesToGrey = findFilesToGrey()"
    ></div>
    <app-header>
        <breadcrumb-nav
            slot="ender"
            $trail="currentPath"
            +crumb-click="onCrumbClick"
        ></breadcrumb-nav>
    </app-header>
    <!-- include ./control-panel.partial.html -->
    <paginate-control
        x-bind:page="currentPage"
        x-bind:max-pages="getNumPages(files)"
        @page-shift="evt => currentPage = setCurrentPage(evt.detail.page)"
    ></paginate-control>

    <div $data-visibility="galleryVisibility">
        <!-- include ./gallery.partial.html -->
    </div>
    <div $data-visibility="fileManagerVisibility">
        <!-- include ./file-manager.partial.html -->
    </div>
    <paginate-control
        x-bind:page="currentPage"
        x-bind:max-pages="getNumPages(files)"
        @page-shift="evt => currentPage = setCurrentPage(evt.detail.page)"
    ></paginate-control>
</app-main>
